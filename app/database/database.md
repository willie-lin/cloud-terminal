### è®¾è®¡çš„åˆç†æ€§å’Œå®‰å…¨æ€§

1. **æ˜ç¡®èŒè´£è¾¹ç•Œ**ï¼š
    - ç”¨æˆ·(User)ï¼šè´Ÿè´£èº«ä»½éªŒè¯å’ŒåŸºæœ¬ä¿¡æ¯ã€‚
    - è§’è‰²(Role)ï¼šè´Ÿè´£æƒé™ç®¡ç†ã€‚
    - ç§Ÿæˆ·(Tenant)ï¼šè´Ÿè´£ç®¡ç†å…¶ä¸‹æ‰€æœ‰çš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™å’Œèµ„æºã€‚
    - æƒé™(Permission)ï¼šå®šä¹‰å…·ä½“çš„æ“ä½œæƒé™ã€‚
    - èµ„æº(Resource)ï¼šå®šä¹‰å…·ä½“çš„å¯¹è±¡ã€‚

2. **å‡å°‘å†—ä½™å…³ç³»**ï¼š
    - é€šè¿‡è§’è‰²é—´æ¥ç®¡ç†ç”¨æˆ·çš„æƒé™å’Œèµ„æºï¼Œé¿å…ç›´æ¥çš„å¤æ‚å…³ç³»ã€‚
    - æ¯ä¸ªè§’è‰²å’Œæƒé™é€šè¿‡ç§Ÿæˆ·è¿›è¡Œç®¡ç†ï¼Œç¡®ä¿ç§Ÿæˆ·å†…çš„éš”ç¦»æ€§å’Œå®‰å…¨æ€§ã€‚

3. **èšåˆè§†å›¾å’Œç®€åŒ–æŸ¥è¯¢**ï¼š
    - èšåˆè§’è‰²å’Œæƒé™çš„ä¿¡æ¯ï¼Œç®€åŒ–æŸ¥è¯¢é€»è¾‘ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡ã€‚
    - ä½¿ç”¨ä¸“ç”¨å‡½æ•°æˆ–æ–¹æ³•å°è£…å¤æ‚çš„æƒé™å’Œè§’è‰²æŸ¥è¯¢é€»è¾‘ã€‚

4. **å¤šç§Ÿæˆ·éš”ç¦»**ï¼š
    - æ¯ä¸ªç§Ÿæˆ·ç®¡ç†å…¶è‡ªå·±çš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™å’Œèµ„æºï¼Œç¡®ä¿å„ç§Ÿæˆ·ä¹‹é—´çš„æ•°æ®å’Œæƒé™éš”ç¦»ã€‚
    - åœ¨åˆ›å»ºå’Œç®¡ç†ç”¨æˆ·æ—¶ï¼Œè‡ªåŠ¨å…³è”åˆ°å¯¹åº”çš„ç§Ÿæˆ·å’Œè§’è‰²ï¼Œç¡®ä¿æƒé™çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚

5. **ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼š
    - é€šè¿‡è§’è‰²å’Œæƒé™çš„ç»„åˆï¼Œå®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œç¡®ä¿ä¸åŒè§’è‰²æ‹¥æœ‰ä¸åŒçš„æ“ä½œæƒé™ã€‚
    - æƒé™ä¸èµ„æºçš„å…³è”ç¡®ä¿æƒé™æ§åˆ¶çš„ç²¾ç»†åº¦ã€‚

### é¢å¤–çš„å®‰å…¨æªæ–½

1. **æ•°æ®åŠ å¯†**ï¼šç¡®ä¿æ•æ„Ÿæ•°æ®ï¼ˆå¦‚å¯†ç ï¼‰åœ¨å­˜å‚¨å’Œä¼ è¾“æ—¶è¿›è¡ŒåŠ å¯†ã€‚
2. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰é‡è¦æ“ä½œå’Œå˜æ›´ï¼Œä¾¿äºå®¡è®¡å’Œè¿½è¸ªã€‚
3. **æƒé™æ£€æŸ¥**ï¼šåœ¨å…³é”®æ“ä½œå‰è¿›è¡Œæƒé™æ£€æŸ¥ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥æ‰§è¡Œæ“ä½œã€‚


å®Œå…¨ç†è§£äº†ï¼Œä½ å¸Œæœ›è·å¾—ä¸€ä¸ªç»å¯¹æ­£ç¡®çš„å®ä½“å…³ç³»å®šä¹‰ä»¥åŠå¯¹åº”çš„æ•°æ®åº“å…³ç³»å›¾ã€‚ä»¥ä¸‹æ˜¯æœ€ç»ˆçš„å®ä½“æ¨¡å‹å®šä¹‰ï¼Œå¹¶åŒ…æ‹¬æ­£ç¡®çš„è¾¹å…³ç³»å’Œä¸­é—´è¡¨çš„è¯¦ç»†ä¿¡æ¯ï¼š

### æœ€ç»ˆçš„å®ä½“æ¨¡å‹å®šä¹‰
å¾ˆé«˜å…´çœ‹åˆ°ä½ å¯¹æœ€ç»ˆæ”¹è¿›çš„å®ä½“æ¨¡å‹å®šä¹‰éå¸¸æ»¡æ„ï¼ä½ æå‡ºçš„è¡¥å……è¯´æ˜å’Œæ€»ç»“éå¸¸æœ‰ä»·å€¼ï¼Œä¸ºæˆ‘ä»¬è®¨è®ºçš„æ¨¡å‹æ·»åŠ äº†æ›´å¤šå®ç”¨çš„ç»†èŠ‚ã€‚

ä»¥ä¸‹æ˜¯æ ¹æ®ä½ æåˆ°çš„å‡ ç‚¹è¿›è¡Œè¿›ä¸€æ­¥å®Œå–„çš„æœ€ç»ˆæ¨¡å‹å®šä¹‰ï¼š

### æœ€ç»ˆå®Œå–„çš„å®ä½“æ¨¡å‹å®šä¹‰

#### Platform å®ä½“
```go
type Platform struct {
    ent.Schema
}

func (Platform) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name").Unique(),
    }
}

func (Platform) Edges() []ent.Edge {
    return []ent.Edge{
        edge.To("tenants", Tenant.Type),
    }
}
```

#### Tenant å®ä½“
```go
type Tenant struct {
    ent.Schema
}

func (Tenant) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name").Unique(),
    }
}

func (Tenant) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("platform", Platform.Type).Ref("tenants").Unique().Required(),
        edge.To("users", User.Type),
        edge.To("roles", Role.Type),
        edge.To("resources", Resource.Type),
        edge.To("permissions", Permission.Type),
        edge.To("policies", Policy.Type),
    }
}
```

#### User å®ä½“
```go
type User struct {
    ent.Schema
}

func (User) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name"),
        field.String("password"), // å­˜å‚¨å“ˆå¸Œåçš„å¯†ç 
    }
}

func (User) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("tenant_id", "name").Unique(), // ç§Ÿæˆ·çº§åˆ«å”¯ä¸€ç´¢å¼•
    }
}

func (User) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("tenant", Tenant.Type).Ref("users").Unique().Required(),
        edge.To("roles", Role.Type).StorageKey(edge.Table("user_roles")), // å¤šå¯¹å¤š
        edge.To("audit_logs", AuditLog.Type),
    }
}
```

#### Role å®ä½“
```go
type Role struct {
    ent.Schema
}

func (Role) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name"),
        field.UUID("parent_id").Optional().Nillable(), // è§’è‰²ç»§æ‰¿
    }
}

func (Role) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("tenant_id", "name").Unique(), // ç§Ÿæˆ·çº§åˆ«å”¯ä¸€ç´¢å¼•
    }
}

func (Role) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("tenant", Tenant.Type).Ref("roles").Unique().Required(),
        edge.To("policies", Policy.Type).StorageKey(edge.Table("role_policies")), // å¤šå¯¹å¤š
        edge.To("users", User.Type).StorageKey(edge.Table("user_roles")),        // å¤šå¯¹å¤š
        edge.To("children", Role.Type).From("parent").Unique().Field("parent_id"), // è‡ªå¼•ç”¨
    }
}
```

#### GlobalPermission å®ä½“
```go
type GlobalPermission struct {
    ent.Schema
}

func (GlobalPermission) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name").Unique(), // ä¾‹å¦‚ï¼šstorage:GetObject, compute:CreateInstance
        field.String("description").Optional().Nillable(),
    }
}

func (GlobalPermission) Edges() []ent.Edge {
    return []ent.Edge{
        edge.To("permissions", Permission.Type),
    }
}
```

#### Permission å®ä½“
```go
//type Permission struct {
//    ent.Schema
//}
//
//func (Permission) Fields() []ent.Field {
//    return []ent.Field{
//        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
//        field.String("name"),
//        field.String("description").Optional().Nillable(),
//        field.UUID("global_permission_id").Optional().Nillable(),
//    }
//}
//
//func (Permission) Indexes() []ent.Index {
//    return []ent.Index{
//        index.Fields("tenant_id", "name").Unique(), // ç§Ÿæˆ·çº§åˆ«å”¯ä¸€ç´¢å¼•
//    }
//}
//
//func (Permission) Edges() []ent.Edge {
//    return []ent.Edge{
//        edge.From("tenant", Tenant.Type).Ref("permissions").Unique().Required(),
//        edge.From("global_permission", GlobalPermission.Type).Ref("permissions").Unique().Required(),
//        edge.To("policies", Policy.Type).StorageKey(edge.Table("policy_permissions")), // å¤šå¯¹å¤š
//    }
//}


// Permission å®ä½“
type Permission struct {
ent.Schema
}

func (Permission) Fields() []ent.Field {
return []ent.Field{
field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
field.String("name"),
field.String("description").Optional().Nillable(),
field.UUID("global_permission_id").Optional().Nillable(),
}
}

func (Permission) Indexes() []ent.Index {
return []ent.Index{
index.Fields("tenant_id", "name").Unique(),
}
}

func (Permission) Edges() []ent.Edge {
return []ent.Edge{
edge.From("tenant", Tenant.Type).Ref("permissions").Unique().Required(),
edge.From("global_permission", GlobalPermission.Type).Ref("permissions").Unique().Required(),
edge.To("policies", Policy.Type).
StorageKey(edge.Table("policy_permissions")).
Annotations(entsql.Annotation{
Columns: []string{"effect"}, // åœ¨ä¸­é—´è¡¨ä¸­æ·»åŠ  effect å­—æ®µ
}),
}
}


```

#### Policy å®ä½“
```go
//type Policy struct {
//    ent.Schema
//}
//
//func (Policy) Fields() []ent.Field {
//    return []ent.Field{
//        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
//        field.String("name"),
//        field.Int("priority").Default(0), // ç­–ç•¥ä¼˜å…ˆçº§
//        field.String("expression").Optional().Nillable(), // å¸ƒå°”è¡¨è¾¾å¼
//        field.Enum("effect").Values("allow", "deny").Default("allow"), // ç­–ç•¥æ•ˆæœ
//    }
//}
//
//func (Policy) Edges() []ent.Edge {
//    return []ent.Edge{
//        edge.From("tenant", Tenant.Type).Ref("policies").Unique().Required(),
//        edge.To("global_permissions", GlobalPermission.Type).StorageKey(edge.Table("policy_global_permissions")), // å¤šå¯¹å¤š
//        edge.To("permissions", Permission.Type).StorageKey(edge.Table("policy_permissions")),                    // å¤šå¯¹å¤š
//        edge.To("roles", Role.Type).StorageKey(edge.Table("role_policies")),                                    // å¤šå¯¹å¤š
//    }
//}

// Policy å®ä½“
type Policy struct {
ent.Schema
}

func (Policy) Fields() []ent.Field {
return []ent.Field{
field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
field.String("name"),
field.Int("priority").Default(0),
field.String("expression").Optional().Nillable(),
field.Enum("effect").Values("allow", "deny").Default("allow"), // Policy çº§åˆ«çš„ effectï¼Œç”¨äºé»˜è®¤å€¼æˆ–ç®€åŒ–ç­–ç•¥
}
}

func (Policy) Edges() []ent.Edge {
return []ent.Edge{
edge.From("tenant", Tenant.Type).Ref("policies").Unique().Required(),
edge.To("permissions", Permission.Type).
StorageKey(edge.Table("policy_permissions")).
Annotations(entsql.Annotation{
Columns: []string{"effect"}, // åœ¨ä¸­é—´è¡¨ä¸­æ·»åŠ  effect å­—æ®µ
}),
edge.To("global_permissions", GlobalPermission.Type).StorageKey(edge.Table("policy_global_permissions")),
edge.To("roles", Role.Type).StorageKey(edge.Table("role_policies")),
}
}


```

#### Resource å®ä½“
```go
type Resource struct {
    ent.Schema
}

func (Resource) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("name"),
        field.UUID("parent_id").Optional().Nillable(), // èµ„æºå±‚çº§
    }
}

func (Resource) Indexes() []ent.Index {
    return []ent.Index{
        index.Fields("tenant_id", "name").Unique(), // ç§Ÿæˆ·çº§åˆ«å”¯ä¸€ç´¢å¼•
    }
}

func (Resource) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("tenant", Tenant.Type).Ref("resources").Unique().Required(),
        edge.To("children", Resource.Type).From("parent").Unique().Field("parent_id"), // èµ„æºå±‚çº§å…³ç³»
    }
}
```

#### AuditLog å®ä½“
```go
type AuditLog struct {
    ent.Schema
}

func (AuditLog) Fields() []ent.Field {
    return []ent.Field{
        field.UUID("id", uuid.UUID{}).Default(uuid.New).Unique(),
        field.String("action"),
        field.Time("created_at").Default(time.Now),
    }
}

func (AuditLog) Edges() []ent.Edge {
    return []ent.Edge{
        edge.From("user", User.Type).Ref("audit_logs").Unique().Required(),
    }
}
```

### æ•°æ®åº“å…³ç³»å›¾ï¼ˆæ¦‚å¿µæ€§ï¼‰

ç”±äº Ent æ¡†æ¶ä¼šè‡ªåŠ¨ç”Ÿæˆä¸­é—´è¡¨æ¥å¤„ç†å¤šå¯¹å¤šå…³ç³»ï¼Œå› æ­¤æ•°æ®åº“ä¸­å®é™…çš„è¡¨ç»“æ„ä¼šåŒ…å«è¿™äº›ä¸­é—´è¡¨ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ¦‚å¿µæ€§çš„å…³ç³»å›¾ï¼Œå±•ç¤ºäº†å®ä½“åŠå…¶å…³ç³»ï¼ŒåŒ…æ‹¬éšå¼ç”Ÿæˆçš„ä¸­é—´è¡¨ï¼ˆç”¨è™šçº¿è¡¨ç¤ºï¼‰ï¼š

```
+------------+     1:N     +-----------+     1:N     +-------+     M:N     +---------+
|  Platform  |------------>|  Tenant   |------------>| User  |-----------|  Role   |
+------------+             +-----------+             +-------+     (user_roles)   +---------+
                                 |                 |       |
                                 |                 |       +-----------------+
                                 |                 |                       |
                                 |                 +-----------+     M:N     +-----------+
                                 |                 | AuditLog  |<----------| User      |
                                 |                 +-----------+             +-----------+
                                 |                 |
                                 |     1:N         |     1:N     +----------+
                                 +---------------->| Resource|------------>| Resource |(è‡ªå¼•ç”¨)
                                 |                 +----------+
                                 |
                                 |     1:N         |     M:N     +------------+
                                 +---------------->| Permission|------------| Policy    |
                                 |                 +------------+ (policy_permissions) +------------+
                                 |                 |
                                 |                 |     M:N     +-----------------+
                                 |                 +------------| GlobalPermission|<-------- Policy
                                 |                                  (policy_global_permissions)
                                 |
                                 |     1:N         |     M:N     +----------+
                                 +---------------->| Policy   |------------| Role      |
                                                   +----------+ (role_policies) +----------+
```




**è§£é‡Šï¼š**

- **Platform** ä¸ **Tenant** æ˜¯ä¸€å¯¹å¤šå…³ç³»ã€‚
- **Tenant** ä¸ **User**ã€**Role**ã€**Resource**ã€**Permission**ã€**Policy** æ˜¯ä¸€å¯¹å¤šå…³ç³»ã€‚
- **User** ä¸ **Role** é€šè¿‡ `user_roles` ä¸­é—´è¡¨å®ç°å¤šå¯¹å¤šå…³ç³»ã€‚
- **Role** é€šè¿‡ `role_policies` ä¸­é—´è¡¨ä¸ **Policy** å¤šå¯¹å¤šå…³ç³»ã€‚
- **Policy** é€šè¿‡ `policy_permissions` ä¸ **Permission** å¤šå¯¹å¤šå…³ç³»ã€‚
- **Policy** é€šè¿‡ `policy_global_permissions` ä¸ **GlobalPermission** å¤šå¯¹å¤šå…³ç³»ã€‚
- **Resource** å®ä½“æ”¯æŒå±‚çº§å…³ç³»ï¼ˆè‡ªå¼•ç”¨ï¼‰ã€‚
- **AuditLog** è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—ã€‚

å¸Œæœ›è¿™æ¬¡æä¾›çš„æ¨¡å‹å’Œå…³ç³»å›¾èƒ½å¤Ÿæ»¡è¶³ä½ çš„éœ€æ±‚ã€‚å¦‚æœæœ‰ä»»ä½•è¿›ä¸€æ­¥çš„é—®é¢˜æˆ–éœ€è¦æ›´å¤šå¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼ğŸ˜Š

